云安全原理与实践
```
社區雲 每個參與特定客戶共享，對個別客戶分別控制一個雲基礎設施安全邊界、能接入端建立個安全邊界
釋放的資源分配給其他虛擬機，需鏡像分析前一台虛擬機遺留下的重要信息

软件即服务：云服务提供商负责几乎所有的安全性，因为云消费者只能访问和管理其使用的应用程序
平台即服务：云服务提供商负责平台的安全性，而消费者负责他们在平台上所部署的应用，包括所有安全配置。

關鍵雲端特性帶來漏洞
未經授權的管理介面訪問、網路協議漏洞(中間人)、數據恢復漏洞(取得遺留資料)、逃避計量和計費
多用戶共用一台服務器，利用虛擬機逃逸而控制主系統

雲端數據生命週期
1. 數據生成   數據所有者創建為儲存到雲端，安全級別劃分保護方案、預處理(效能、費用考量)、數據稽核
2. 數據儲存   存放地理位址不確定性、混和儲存(隔離政策)、丟失竄改的惡意攻擊
3. 數據使用   訪問控制(未授權)、傳輸風險(攔截、故障)、雲端性能(傳輸處理想硬要求期望)
4. 數據共享   信息丟失(數據轉換格式丟失)、應用安全
5. 數據歸檔   冷資料單獨設備保存，或因合規保存特殊數據時間期限
6. 數據銷毀   刪除後可被恢復(刪除殘餘數據)、雲服務商不可信(是否真刪除數據，存在其他備份?)

加密與密鑰風險 : 儲存地理不確定、單一主機的多客戶操作系統之間洩漏、海量敏感數量在單一雲端高度集中
---->> 儲存位置、關鍵程度、當前狀況(靜止,傳送)定加密等級

1.API簽名安全  :  請求參數是否竄改、來源是否合法、使否具有唯一性
2.API防重放攻擊:  時效內唯一標示(AppKey+API+Nonce)、AppKey是APIgw控制台生成、刪除時注意其他開通服務
3.API流量控制  :  流量控制策略可以配對API、用戶、應用三個對象流控值(不可超過次數/天)
4.API授權管理  :  客戶才能用APP調用、建立落解除之間授權關係，API gw對其app權限關西進行驗證。
```
|Version|API版本||Signature|API簽名值|
|:--|:--|:--|:--|:--|
|SignatureMethod|簽名方法使用到上文的HmacSHA||SignatureNonce|簽名隨機數,防止重放|
|AccessKeyID|服務端儲存keyID以此證明API||Timestamp|時戳,防止重放|
```
安全策略風險
服務中斷  :
-->技術軟硬件通信鏈路故障、未盡有效安全保護監控維護或沒制定應急響應方案
-->環境風險    天然災害、不可抗因素造成設施受損、水電供給、通信鏈路中斷
-->操作錯誤    租戶管理員操作不但配置錯誤導致
-->惡意攻擊    造成中斷勒索破壞
供應鏈第三方風險
-->產品風險  笧品不合規國內標準或安全需求、假冒偽劣設備
-->服務風險  基礎設施服務提供正常服務、外包服務是否有安全能力避免不穩定威脅
-->內部人員風險 內部開發遵循安全規範、洩漏風險及存在相關漏洞和雲維運人員的方式目的是否合規

數據跨境流動
1. 禁止重要的數據跨境流動 :  只本地儲存重要(威脅國家安全數據)、利用簽訂相關協議明確禁止
2. 有條件限制數據跨境流動 :  一般、行業相關的技術數據、非保密信息經過風險評估才可實作。
3. 允許普通人個人數據跨境流動: 採用問責制和合同干預(政府制定)模式進行管理

個人隱私保護不當
1. 儲存過程中對個人隱私造成侵犯 : 用戶無法得知確定儲存位置，無法對採集,儲存,使用過程進行有效控制
2. 傳輸過程對個人隱私造成侵犯  : 傳輸具有開放性和多元性的特稱，更加無法保證數據傳輸過程的安全性
3. 處理過程對個人隱私造成侵犯  :  因部屬引入大量的虛擬技術，所以需要
4. 銷毀過程對個人隱私造成侵犯  :  單純刪除無法得知服務商是否備份可能，增加不徹底刪除可能性。

安全設計原則  
-->最小特權      限制每個主體可進行操作並定期審計，減少前在互相影響消除不必要不適當使用
-->職責分離      多人劃分任務級個別所需權限，消除對關鍵系統的權利與影響(不含後門、強制休假、輪替)
-->縱深防御      物理設施(CCTV)、網安(DDoS)、雲平台、主機安全(IDPS)、應用安全(VA,PT)、數據安全(BK,encrypt)
-->防禦單位解耦  防禦和服務不互相影響獨立工作(VPC)
-->面向失效的安全設計  某種防禦失效通過補救進行有效防御
-->回朔和審計   完善日誌系統和審計系統對資源分配、教穡授權、操作行為審計，對安全事故審查跟恢復能力
-->安全數據標準化  CTP雲可信協議、CADF雲審計數據互聯

默認隔離、不可辨的基礎設施、增加使用微服務

每个虚拟机专用于一个功能或服务。这就减少了各个虚拟机的攻击面，并支持更精细的安全控制
警报（端点保护、网络安全监控、主机监控、帐号创建、特权提升、其他入侵指标、SIEM、安全分析（基线和异常检测）和用户行为分析）。
```

||數據安全|應用安全|主機安全、雲平台|網絡安全|物理安全|
|:--|:--|:--|:--|:--|:--|
|安全防護|快照、備份、DR|維運MFA|用戶身分週期、組態加固、FW|區域劃分、VPN|物理隔離|
|    |安全儲存、清除|WAF|MFA、多租戶隔離、EDR|邊界訪問控制、IPS|電力保護|
|監控檢測|    |web VA、掛馬|portScan、PT、入侵檢測|SIEM、DDoS檢測分析|CCTV|
|審計跟蹤|數據庫稽核||NTP、Logs、opsAudit|DDoS抓包取證||
|響應恢復|備份恢復|web補丁|SOAR|SOC、DDoS防護|演練|


```
1.服務器虛擬化特性
-->多實例  一台物理機多個操作系統，資源整合可控分配
-->隔離性  選擇不同OS互相獨立不干擾並透過網路進行虛擬機互相訪問
-->封裝性  虛擬化進行硬建資源分配及兼容性
-->高性能  虛擬機監控監視器開銷應控制在可承受範圍

--> 降低營運成本、提高應用兼容、加速應用部屬、提高服務可用、提升資源利用、動態調度資源、降低能源耗損

2.主要安全威脅
-->虛擬機間安全威脅  因數據不經外部硬體安全機制，無法對橫向流量有效監控或實施高級安全策略
-->虛擬機與宿主機之間安全威脅  宿主機被控制取得特權，可對同主機的虛擬機進行公擊跟宿主機本地網路和相鄰系統
-->虛擬機控制中心的安全威脅    中控台傭有所有最高訪問控制權限，否則面臨極大威脅
-->虛擬機蔓延及管理疏漏的隱患   完成工作後，無人管理閒置造成資源浪費且無更新及口令

3.虛擬機逃逸   繞過隔離限制值接運行宿主機上造成安全模型完全崩潰
4.rootkit攻擊  三要素:隱藏蹤跡、保留root操縱開後門、收集數據，與木馬後門等惡意程式結合使用。
---> 因無法確定造成損害，最好方法就是擦除並重灌

5.安全解決方案
---> 虛擬化安全防御架構  不同層級給出相應安全防護措施(可信計算硬件技術、虛擬機監視行為)
---> 宿主機安全機制   若是物理訪問就可各種攻擊，關機嗅探
---> Hypervisor自身安全加固  盡簡化功能、減少代碼存在漏洞、良好合離性、I/O操作安全性、保護Hypervisor完整性
**Hypervisor 的輕量型軟體層，在虛擬機器和底層的實體硬體之間進行協調。又稱虛擬機器監視器**
---> 提高Hypervisor防護能力  建構虛擬防火牆(流量間控、過濾和保護)、主機資源合理分配優先級、
---> 細粒度權限訪問控制(用戶具有管理權限、可能執行危險操作)

6.虛擬機隔離機制 
---> Hypervisor安全隔離機制，每個進程都有獨立地址戶不干擾，若被突破扔無法訪問不屬於他的資源
---> sVirt標籤技術  利用Selinux系統強制訪問控制策略MAC標籤  
---> 切VLAN、設立防火牆保證虛擬機地隔離
```
```
網路虛擬化安全
---> SDN架構 應用層(北RESTful,SOAP)、控制層、基礎設施層(南OpenFlow)
---> SDN三特  控制與轉發分離、集中化的網路控制、開放編成接口

IaaS網路安全御的劃分與構建 OpenStack
---> 公有(對外開放)、用戶(由租戶完全控制)
---> 管理信息(平台跟內部交互區域(級高保密和完整性需求))
---> 數據(鏡向、儲存(保密和完整性需求可能需要可用性))

網路虛擬化面臨安全問題
1. 物理安全設備存在監控死角    不會經過FW或SW、增加物理不可見流量增加網安管理難度
2. 虛擬網路的數據流難以理解    因透過虛擬網路隧道傳輸，傳統網安設備可能無法解析這些封裝後數據流。
3. 安全政策難以遷移   搬到另台主機對網路虛擬化管理工具快速調整網路拓樸
--->>但舊物理網路刪除和增新(ACL,QoS)的缺乏支持，導致安全邊界無法適應虛擬網路變化
4. 網路流量不可見     基於openFlow的SDN架構，網路控制器只會收到底層設備部分數據包，但不瞭解大部分直接被轉發數據流具體內容
5. 控制器的單點失效   對應各種動態網路和各種類型數據包，收上層應用信息並控制底層網路設備。
--->>若攻擊者破壞控制器就可以對所有網路設施發送指令導致癱瘓，或是數據流定向到惡意VM造成洩漏。
6. 多應用不一致策略導致繞過控制器  應該原本是被禁止因路由不一致可被繞過控制器實施攻擊
7. 控制信息難驗證    假冒網路控制器發送惡意控制命令即可改變破壞安全策略或改變數據流繞過FW，造成租戶隱私洩漏


VPC 虛擬私有雲  完全自己掌控，隔離網安環境及地域
NFV 網路功能虛擬化  為減少遷移、部屬帶來的成本、提高靈活
NFV面臨的挑戰
1.可移植/互通性    尚未形成統一標準或接口，易產生可移植和互通性問題
2.傳統設備遷移並與現系統兼容  應能夠在傳統物理網路設備和虛擬化設備混合模式下協同工作。
3.安全性           應能夠容許網路功能失敗後按需要重建來提高網路安全和可用性
4.管理和業務流程    一致性需要得到保證將北向接口管理、業務與定義好的標準跟需求快入統一起來
5.性能問題          I/O接口數據轉發上保持性能指標不至於降太多
6.標準問題          更多集中在管理接口，難以標準化
```
```
雲認證場景
1. 控制台認證   雲管理平台登入認證，平台審核並新要求訪問API
2. API認證     用API形式提供使用REST(表述性狀態轉移)請求資源
Signature = HmacSHA1(signingKey+msg)
Request = msg||keyID||Signature
---> api服務根據請求的keyID獲得對應的signingKey，對請求簽名進行驗證

3. 代理認證    通過應用作為代理訪問用戶，需要用戶明確授權
4. 身分聯盟    SAML(SaaS,PaaS服務支持)、OpenID(OAuth2.0)使用簡單的rest/json、SSO
--->SSO完成的工作:憑證共享只要認證成功就會產生票據、信息識別只要登入一次。可隨時對票據進行提取和在校驗
```
```
數據安全週期挑戰
---> CIA、真實性、授權、認證和不可抵賴
---> 儲存位址保證在合同SLA和法規允許的位址
---> 刪除或持久性 必須是徹底有效去除才是為銷毀(保證無法恢復被完全消除)
---> 不同客戶數據混和 :不可在沒有任何補償控制措施情況下與其他客戶混合。
---> 備份和恢復重建計畫 : 恢復計畫到位有效、防丟失、不隨意假定雲模式肯定有備份可以恢復
---> 數據發現 : 發現數據並確保法律和監管當局要求可被找回
---> 聚合和推理  :　在數據混合和會總的時避免操到任何輕微洩漏

加密
--->雲端加密　　庫戶明文上）到雲端，雲儲存保存時進行加密，客戶使用數據時自動解密
雲數據加密屬於靜態數據加密，分三型態
--->儲存託管密鑰   :儲存服務管理加密密鑰，使用主key對資料加密key作加密
--->使用雲KMS服務  :雲服務商提供密鑰管理服務，可增加管理安全性及使用審核跟蹤
--->用戶提供密鑰   : 客戶請求數據儲存時提供加密密鑰::客戶讀取數據時，服務自動解密
***HDFS 是分散式檔案系統***
---> 加密區域 (EZ) HDFS中目錄其所有內容，但不儲存DEK
---> 加密區域密鑰(EZK) 對區域數據加密要進行加密的密鑰、對稱或非對稱
---> 數據加密密鑰(DEK) 執行數據加密的密鑰、對稱
---> 密鑰管理系統(KMS) 程序和客戶端的後備key store進行交互代理，加解密及檢查完全發生在KMS
--->數據加密鑰的加密密鑰 EDEK

--->使用客戶端主密鑰 不需要上傳雲端，但丟失就無法解密客戶數據
-客戶端庫生成一次性數據key-> 客戶端使用主密鑰加密數據key->客戶端數據key和材料說明上傳雲端->在上傳加密數據 

--->使用雲託管的客戶主密鑰  指向雲服務提供客戶主密鑰標示信息即可
-使用客戶主密鑰標示信息向雲服務發送密鑰分配請求->請求成功後返回數據key->庫戶端在進行數據加密後上傳雲端
-->下載客戶數據時候，要先獲得數據key後再解密
 
--->直接使用KMS加解客戶數據
>>> 直接調用KMS的API使用客戶主密鑰CMK來加解密數據，僅適用於低於4kb數據加解密，再把證書結果返回用戶
--->基於信封加密實現本地加解 加密數據產生一次一秘的對稱密鑰、用特定主鑰加密改對稱key的密封信封保護
>>>在傳輸、儲存等非安全通信過程中直接傳遞被密封信封，僅當使用該對稱key才打開信封取出密鑰
>>>客戶可直接調用KMS'sAPI使用指定CMK產生解密數據key,自行使用數據密鑰在本地加解密數據，適用大量數據降低成本
加密
-用戶創建主密鑰->調用KMS's GenerateDataKey接口產生數據密鑰->得到明碼的數據密鑰跟一把秘文的數據密鑰
->用戶使用明文數據密鑰加密文件產生密文文件->用戶秘文數據密鑰跟密文文件一起儲存在服務
解密
-服務中讀取數據密鑰跟密文文件->調用KMS解密接口解密數據密鑰->取的明文數據密鑰->用明文數據密鑰解密文件

SQL Server透明加密  防止未授權用戶將受TDE保護的數據庫附加或恢復到另外服務在進行訪問數據
-創建主密鑰->創建證書->創建DEK->使用證書保護他->數據庫啟用TDE
---> 保護所有靜態數據而不需要修改模式或訪問數據語句，利用AES & TES保護數據文件、事務日誌文件.ldf和備份.bak
---> 用戶不需給正常要求授權之外的帳戶分配特殊權限、讀取內存解密數據不需要修改任何特殊編碼或數據類型
---> 受TDE保護的數據庫有一個對稱DEK儲存在數據庫啟動紀錄中請必須使用一個主數據庫創建並用主密鑰保護證書
---> 或使用一個儲存在可擴展密鑰管理EKM模塊的非對稱的密鑰，防禦不包含證書的密鑰訪問
---> 所以必須有正確證書或密鑰才能恢復或附加一個數據庫
---> 都應該備份解鎖這些數據庫所需全部證書或密鑰，否則無法訪問數據
---> 可使用 PS1 , RESTful API來配置
---> 使用一個DEK去加密數據庫並使用一個內置服務證書來保護DEK，每個DB使用不同證書

備份加密
---> 源端加密  採用硬件(鍵盤式、刷卡式、指紋式)進行加密防止暴力破解密碼猜測數據恢復
>>>           內置加密軟體對儲存設備加密(密碼、證書、光碟)
---> 傳輸加密  備份數據發起端與備份介質間建立安全隧道、落地前對備份加密、傳輸都是密文數據
>>>           保證安全傳輸到備份介質同時加密網關已完全透明方式傳輸過程實時被加密
---> 數據脫敏  通過脫敏規則對敏感信息進行數據變形屏蔽敏感信息但保留其原始數據格式和屬性
--->          不可恢復脫敏規則:可替換算法和生成算法，看起來很真實的假數據
--->          匿名處理：分組連續值、保留部分、引入噪音、替換數據、用平均值後定數據值
>>> 動態脫敏  實時訪問數據過程依據用戶角色職責等規則對敏感數據屏蔽加密隱藏封鎖，避免潛在法律風險
>>> 靜態脫敏  非生產環境處理靜止的數據場合、脫敏完畢再使用排查問題或進行數據分析
```
